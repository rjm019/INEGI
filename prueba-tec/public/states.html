<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>INEGI Estados — Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; }
    .contenedor { padding: 24px 16px; }
    .tabla-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
    .tabla-card .card-header { background: #fff; border-bottom: 0; }
    .acciones-toolbar .btn { margin-right: .5rem; }
    .toast-container { z-index: 1080; }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand fw-semibold" href="#">INEGI Estados</a>
      <div class="ms-auto acciones-toolbar">
        <button id="btnSincronizar" class="btn btn-secondary">Sincronizar</button>
        <button id="btnReSincronizar" class="btn btn-outline-secondary">Re-Sincronizar</button>
        <button id="btnDeduplicar" class="btn btn-danger">Deduplicar</button>
        <button id="btnVaciar" class="btn btn-warning">Vaciar BD</button>
      </div>
    </div>
  </nav>

  <div class="container contenedor">

    <div class="d-flex align-items-center mb-3">
      <label for="selectBloque" class="me-2">Bloque:</label>
      <select id="selectBloque" class="form-select" style="width: 140px;">
        <option value="10" selected>10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>

    <div class="card tabla-card">
      <div class="card-header">
        <h5 class="card-title mb-0">Listado de estados</h5>
      </div>
      <div class="card-body">
        <table id="tablaEstados" class="table table-striped table-hover w-100"></table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalEstado" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" onsubmit="return false;">
        <div class="modal-header">
          <h5 class="modal-title">Detalle del estado</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">cvegeo</label>
            <input id="campoCvegeo" type="text" class="form-control" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">cve_ent</label>
            <input id="campoCveEnt" type="text" class="form-control" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">nomgeo</label>
            <input id="campoNomgeo" type="text" class="form-control" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">nom_abrev</label>
            <input id="campoNomAbrev" type="text" class="form-control" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">pob_total</label>
            <input id="campoPobTotal" type="text" class="form-control" disabled>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastAviso" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Aviso</strong>
        <small class="text-muted">ahora</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>

  <script>
    // ← ahora usa el host actual (local o Railway)
    const API_BASE = window.location.origin;

    function formatearNumero(valor) {
      if (valor == null) return '';
      return new Intl.NumberFormat('es-MX').format(valor);
    }

    function mostrarToast(mensaje) {
      const toast = document.getElementById('toastAviso');
      toast.querySelector('.toast-body').textContent = mensaje;
      const instancia = bootstrap.Toast.getOrCreateInstance(toast);
      instancia.show();
    }

    $(function () {
      const bloqueInicial = parseInt(document.getElementById('selectBloque').value, 10) || 10;

      const tabla = $('#tablaEstados').DataTable({
        processing: true,
        serverSide: true,
        searching: true,
        lengthChange: false, 
        dom: 'frtip',
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        pageLength: bloqueInicial,
        ajax: {
          url: `${API_BASE}/api/states`,
          type: 'GET',
          data: function (params) {
            const valor = parseInt($('#selectBloque').val(), 10) || 10;
            params.length = valor;
          },
          dataSrc: 'data',
          error: function () {
            mostrarToast('Error al cargar la lista de estados.');
          }
        },
        columns: [
          { data: 'cve_ent', title: 'Clave' },
          { data: 'nomgeo', title: 'Estado' },
          { data: 'nom_abrev', title: 'Abrev.' },
          {
            data: 'pob_total',
            title: 'Población',
            render: function (data) { return formatearNumero(data); },
            className: 'text-end'
          },
          {
            data: null,
            title: 'Acciones',
            orderable: false,
            searchable: false,
            className: 'text-center',
            render: function (data, type, row) {
              return `<button class="btn btn-primary btn-sm boton-ver" data-cve="${row.cve_ent}">Ver</button>`;
            }
          }
        ],
        language: {
          url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json'
        }
      });

      $('#btnSincronizar').on('click', async function () {
        const boton = this;
        boton.disabled = true;
        boton.innerText = 'Sincronizando...';
        try {
          const res = await fetch(`${API_BASE}/api/states/sync`, { method: 'POST' });
          const json = await res.json();
          mostrarToast(`Sync OK. Insertados: ${json.insertados || 0}, Actualizados: ${json.actualizados || 0}, Sin cambios: ${json.sin_cambios || 0}`);
          tabla.ajax.reload(null, false);
        } catch (e) {
          mostrarToast('Error al sincronizar.');
        } finally {
          boton.disabled = false;
          boton.innerText = 'Sincronizar';
        }
      });

      $('#btnReSincronizar').on('click', async function () {
        const boton = this;
        boton.disabled = true;
        boton.innerText = 'Sincronizando...';
        try {
          const res = await fetch(`${API_BASE}/api/states/sync?resynchronize=1`, { method: 'POST' });
          const json = await res.json();
          mostrarToast(`Sync OK. Insertados: ${json.insertados || 0}, Actualizados: ${json.actualizados || 0}, Sin cambios: ${json.sin_cambios || 0}`);
          tabla.ajax.reload(null, false);
        } catch (e) {
          mostrarToast('Error al re-sincronizar.');
        } finally {
          boton.disabled = false;
          boton.innerText = 'Re-Sincronizar';
        }
      });

      $('#btnDeduplicar').on('click', async function () {
        const boton = this;
        if (!confirm('¿Eliminar duplicados dejando 1 por clave?')) return;
        boton.disabled = true;
        boton.innerText = 'Limpiando...';
        try {
          const res = await fetch(`${API_BASE}/api/states/deduplicate`, { method: 'POST' });
          const json = await res.json();
          mostrarToast(`Duplicados eliminados: ${json.filas_eliminadas || 0}`);
          tabla.ajax.reload(null, false);
        } catch (e) {
          mostrarToast('Error al deduplicar.');
        } finally {
          boton.disabled = false;
          boton.innerText = 'Deduplicar';
        }
      });

      $('#btnVaciar').on('click', async function () {
        const boton = this;
        if (!confirm('¿Vaciar completamente la tabla de estados?')) return;
        boton.disabled = true;
        boton.innerText = 'Vaciando...';
        try {
          const res = await fetch(`${API_BASE}/api/states/clear`, { method: 'POST' });
          const json = await res.json();
          mostrarToast(json.mensaje || 'Tabla vaciada');
          tabla.ajax.reload(null, false);
        } catch (e) {
          mostrarToast('Error al vaciar la tabla.');
        } finally {
          boton.disabled = false;
          boton.innerText = 'Vaciar datos';
        }
      });

      $('#tablaEstados').on('click', '.boton-ver', async function () {
        const clave = this.getAttribute('data-cve');
        try {
          const res = await fetch(`${API_BASE}/api/states/${clave}`);
          if (!res.ok) throw new Error('No encontrado');
          const detalle = await res.json();

          document.getElementById('campoCvegeo').value = detalle.cvegeo ?? '';
          document.getElementById('campoCveEnt').value = detalle.cve_ent ?? '';
          document.getElementById('campoNomgeo').value = detalle.nomgeo ?? '';
          document.getElementById('campoNomAbrev').value = detalle.nom_abrev ?? '';
          document.getElementById('campoPobTotal').value = formatearNumero(detalle.pob_total);

          const modal = new bootstrap.Modal(document.getElementById('modalEstado'));
          modal.show();
        } catch (e) {
          mostrarToast('Error al cargar el detalle.');
        }
      });

      $('#selectBloque').on('change', function () {
        const valor = parseInt(this.value, 10);
        tabla.page.len(valor).draw();
      });
    });
  </script>
</body>
</html>
